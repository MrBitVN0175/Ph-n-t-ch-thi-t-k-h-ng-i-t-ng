<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Danh Mục Hàng Hóa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Toggle Switch CSS */
        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
    </style>
</head>
<body class="h-screen w-full flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-blue-800 text-white h-12 flex items-center justify-between px-4 shadow-md shrink-0">
        <div class="flex items-center space-x-4">
            <a href="supermarket_system.html" class="hover:text-blue-200"><i class="fas fa-arrow-left mr-1"></i> Trang chủ</a>
            <span class="font-bold text-lg">|</span>
            <span class="font-bold text-lg uppercase"><i class="fas fa-box-open mr-2"></i>Quản Lý Hàng Hóa</span>
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-sm font-mono bg-blue-900 px-2 py-1 rounded" id="today-date">--/--/----</span>
            <span class="font-semibold"><i class="fas fa-user-edit mr-1"></i> Quản Lý</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col p-4 overflow-hidden space-y-4">
        
        <!-- 1. TOOLBAR -->
        <div class="bg-white p-4 rounded-xl shadow-sm flex flex-wrap gap-4 justify-between items-center shrink-0">
            <div class="flex items-center space-x-2 w-full md:w-auto">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="search-input" onkeyup="handleSearch()" 
                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 md:w-80" 
                        placeholder="Tìm theo Tên hoặc Mã vạch...">
                </div>
                
                <select id="filter-status" onchange="handleSearch()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none bg-white">
                    <option value="all">Tất cả trạng thái</option>
                    <option value="active">Đang kinh doanh</option>
                    <option value="inactive">Ngưng kinh doanh</option>
                </select>
            </div>

            <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow transition flex items-center transform hover:-translate-y-1">
                <i class="fas fa-plus mr-2"></i> Thêm Hàng Mới
            </button>
        </div>

        <!-- 2. DATA GRID -->
        <div class="flex-grow bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden">
            <div class="overflow-y-auto flex-grow">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-4 w-32">Mã Vạch</th>
                            <th class="p-4">Tên Sản Phẩm</th>
                            <th class="p-4 w-24 text-center">ĐVT</th>
                            <th class="p-4 w-32 text-right">Giá Bán</th>
                            <th class="p-4 w-24 text-center">Tồn Kho</th>
                            <th class="p-4 w-32 text-center">Vị Trí</th>
                            <th class="p-4 w-32 text-center">Trạng Thái</th>
                            <th class="p-4 w-24 text-center">Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body" class="text-sm text-gray-700">
                        <!-- JS Render -->
                    </tbody>
                </table>
                
                <!-- Empty State -->
                <div id="empty-state" class="hidden h-64 flex flex-col items-center justify-center text-gray-400">
                    <i class="fas fa-boxes text-5xl mb-3 opacity-50"></i>
                    <p>Không tìm thấy sản phẩm nào.</p>
                </div>
            </div>

            <!-- Pagination (Mock UI) -->
            <div class="p-3 bg-gray-50 border-t flex justify-between items-center text-xs text-gray-500 shrink-0">
                <span>Hiển thị <b id="showing-count">0</b> sản phẩm</span>
                <div class="flex space-x-1">
                    <button class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50" disabled><i class="fas fa-chevron-left"></i></button>
                    <button class="px-3 py-1 border rounded bg-blue-600 text-white font-bold">1</button>
                    <button class="px-3 py-1 border rounded bg-white hover:bg-gray-100">2</button>
                    <button class="px-3 py-1 border rounded bg-white hover:bg-gray-100">3</button>
                    <button class="px-3 py-1 border rounded bg-white hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </main>

    <!-- 3. MODAL FORM (Add / Edit) -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-[800px] max-h-[90vh] flex flex-col transform transition-all scale-100">
            <!-- Header -->
            <div class="bg-blue-600 p-4 rounded-t-xl flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold text-lg flex items-center" id="modal-title">
                    <i class="fas fa-box-open mr-2"></i> Thêm Sản Phẩm Mới
                </h3>
                <button onclick="closeModal()" class="hover:text-gray-200 transition"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Body -->
            <div class="p-6 overflow-y-auto flex-grow">
                <input type="hidden" id="prod-id"> <!-- ID ẩn để biết đang sửa hay thêm -->
                
                <div class="grid grid-cols-2 gap-6">
                    <!-- Cột trái: Thông tin cơ bản -->
                    <div class="space-y-4">
                        <h4 class="font-bold text-gray-700 border-b pb-1">Thông Tin Cơ Bản</h4>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-1">Mã Vạch (Barcode) <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="text" id="prod-barcode" onblur="checkDuplicateBarcode()" class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Quét hoặc nhập mã...">
                                <span class="absolute right-3 top-2 text-gray-400"><i class="fas fa-barcode"></i></span>
                            </div>
                            <p id="barcode-error" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-1">Tên Sản Phẩm <span class="text-red-500">*</span></label>
                            <input type="text" id="prod-name" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="VD: Mì Hảo Hảo...">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1">Đơn Vị Tính <span class="text-red-500">*</span></label>
                                <select id="prod-unit" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                    <option value="Cái">Cái</option>
                                    <option value="Gói">Gói</option>
                                    <option value="Hộp">Hộp</option>
                                    <option value="Chai">Chai</option>
                                    <option value="Lon">Lon</option>
                                    <option value="Thùng">Thùng</option>
                                    <option value="Kg">Kg</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1">Nhóm Hàng</label>
                                <select id="prod-group" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                    <option value="Thực phẩm">Thực phẩm</option>
                                    <option value="Đồ uống">Đồ uống</option>
                                    <option value="Hóa mỹ phẩm">Hóa mỹ phẩm</option>
                                    <option value="Gia dụng">Gia dụng</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Cột phải: Giá & Kho -->
                    <div class="space-y-4">
                        <h4 class="font-bold text-gray-700 border-b pb-1">Giá & Kho Hàng</h4>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-1">Giá Bán (VNĐ) <span class="text-red-500">*</span></label>
                            <input type="number" id="prod-price" min="0" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none font-bold text-blue-700" placeholder="0">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1">Tồn Kho Hiện Tại</label>
                                <input type="number" id="prod-stock" min="0" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1">Định Mức Min</label>
                                <input type="number" id="prod-min-stock" min="0" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="10">
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-1">Vị Trí Kệ Hàng</label>
                            <input type="text" id="prod-location" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="VD: Kệ A1, Tủ đông...">
                        </div>

                        <div class="pt-2">
                            <label class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="prod-status" class="sr-only toggle-checkbox" checked>
                                    <div class="toggle-label block w-10 h-6 bg-gray-300 rounded-full transition-colors"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform toggle-checkbox:translate-x-full"></div>
                                </div>
                                <div class="ml-3 text-gray-700 font-medium">Đang Kinh Doanh</div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end space-x-2 border-t shrink-0">
                <button onclick="closeModal()" class="px-5 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded font-medium transition">Hủy Bỏ</button>
                <button onclick="saveProduct()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow transition flex items-center">
                    <i class="fas fa-save mr-2"></i> Lưu Dữ Liệu
                </button>
            </div>
        </div>
    </div>

    <script>
        /* =========================================
           1. SETUP DATA & VARS
        ========================================= */
        const STORAGE_KEY = 'supermarket_db';
        let db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        let products = db.products || [];

        // DOM Elements
        const tableBody = document.getElementById('product-table-body');
        const emptyState = document.getElementById('empty-state');
        const modal = document.getElementById('product-modal');
        const modalTitle = document.getElementById('modal-title');
        const barcodeError = document.getElementById('barcode-error');

        // Form fields
        const inputId = document.getElementById('prod-id');
        const inputBarcode = document.getElementById('prod-barcode');
        const inputName = document.getElementById('prod-name');
        const inputUnit = document.getElementById('prod-unit');
        const inputPrice = document.getElementById('prod-price');
        const inputStock = document.getElementById('prod-stock');
        const inputMinStock = document.getElementById('prod-min-stock');
        const inputLocation = document.getElementById('prod-location');
        const inputStatus = document.getElementById('prod-status');

        const formatMoney = (amount) => new Intl.NumberFormat('vi-VN').format(amount);

        window.onload = function() {
            document.getElementById('today-date').innerText = new Date().toLocaleDateString('vi-VN');
            renderTable(products);
        };

        /* =========================================
           2. RENDER & SEARCH
        ========================================= */
        function renderTable(data) {
            tableBody.innerHTML = '';
            document.getElementById('showing-count').innerText = data.length;

            if (data.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50 transition group";
                
                // Trạng thái
                const isActive = item.status !== false; // Mặc định là true nếu undefined
                const statusBadge = isActive 
                    ? '<span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700">Đang bán</span>'
                    : '<span class="px-2 py-1 rounded text-xs font-bold bg-gray-100 text-gray-500">Ngưng bán</span>';

                // Style dòng nếu ngưng bán
                if (!isActive) tr.classList.add('opacity-60', 'bg-gray-50');

                tr.innerHTML = `
                    <td class="p-4 font-mono font-medium text-blue-600">${item.barcode}</td>
                    <td class="p-4 font-bold text-gray-700">${item.name}</td>
                    <td class="p-4 text-center">${item.unit}</td>
                    <td class="p-4 text-right font-medium">${formatMoney(item.price)} ₫</td>
                    <td class="p-4 text-center ${item.stock <= item.minStock ? 'text-red-500 font-bold' : ''}">${item.stock}</td>
                    <td class="p-4 text-center text-gray-500 text-xs">${item.location}</td>
                    <td class="p-4 text-center">${statusBadge}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editProduct('${item.id}')" class="text-blue-500 hover:text-blue-700 p-1" title="Sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct('${item.id}')" class="text-red-400 hover:text-red-600 p-1" title="Xóa/Ngưng">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function handleSearch() {
            const keyword = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;

            const filtered = products.filter(p => {
                const matchesKeyword = p.name.toLowerCase().includes(keyword) || p.barcode.includes(keyword);
                const isActive = p.status !== false;
                
                let matchesStatus = true;
                if (statusFilter === 'active') matchesStatus = isActive;
                if (statusFilter === 'inactive') matchesStatus = !isActive;

                return matchesKeyword && matchesStatus;
            });

            renderTable(filtered);
        }

        /* =========================================
           3. MODAL LOGIC
        ========================================= */
        function openModal(isEdit = false) {
            modal.classList.remove('hidden');
            barcodeError.classList.add('hidden');
            inputBarcode.classList.remove('border-red-500');

            if (!isEdit) {
                modalTitle.innerHTML = '<i class="fas fa-box-open mr-2"></i> Thêm Sản Phẩm Mới';
                inputId.value = '';
                // Reset form
                inputBarcode.value = '';
                inputBarcode.readOnly = false;
                inputBarcode.classList.remove('bg-gray-100');
                
                inputName.value = '';
                inputUnit.value = 'Cái';
                inputPrice.value = '';
                inputStock.value = '0';
                inputMinStock.value = '10';
                inputLocation.value = '';
                inputStatus.checked = true;
                
                setTimeout(() => inputBarcode.focus(), 100);
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function editProduct(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;

            openModal(true);
            modalTitle.innerHTML = '<i class="fas fa-edit mr-2"></i> Cập Nhật Sản Phẩm';
            
            inputId.value = p.id;
            
            inputBarcode.value = p.barcode;
            // Không cho sửa mã vạch khi edit để tránh lỗi logic
            inputBarcode.readOnly = true; 
            inputBarcode.classList.add('bg-gray-100');

            inputName.value = p.name;
            inputUnit.value = p.unit;
            inputPrice.value = p.price;
            inputStock.value = p.stock;
            inputMinStock.value = p.minStock || 10;
            inputLocation.value = p.location || '';
            inputStatus.checked = p.status !== false;
        }

        function checkDuplicateBarcode() {
            const code = inputBarcode.value.trim();
            const currentId = inputId.value;
            
            // Nếu đang sửa thì bỏ qua chính nó
            const exists = products.find(p => p.barcode === code && p.id !== currentId);
            
            if (exists) {
                barcodeError.innerText = "Mã vạch này đã tồn tại!";
                barcodeError.classList.remove('hidden');
                inputBarcode.classList.add('border-red-500');
                return true;
            } else {
                barcodeError.classList.add('hidden');
                inputBarcode.classList.remove('border-red-500');
                return false;
            }
        }

        function saveProduct() {
            // Validate Basic
            if (!inputBarcode.value.trim()) return alert("Vui lòng nhập Mã vạch!");
            if (checkDuplicateBarcode()) return; // Stop if duplicate
            if (!inputName.value.trim()) return alert("Vui lòng nhập Tên sản phẩm!");
            if (inputPrice.value < 0 || inputPrice.value === '') return alert("Giá bán không hợp lệ!");
            
            const newProduct = {
                id: inputId.value || 'SP' + Date.now(),
                barcode: inputBarcode.value.trim(),
                name: inputName.value.trim(),
                unit: inputUnit.value,
                price: parseInt(inputPrice.value),
                stock: parseInt(inputStock.value) || 0,
                minStock: parseInt(inputMinStock.value) || 0,
                location: inputLocation.value.trim(),
                status: inputStatus.checked
            };

            if (inputId.value) {
                // UPDATE
                const idx = products.findIndex(p => p.id === inputId.value);
                if (idx !== -1) {
                    products[idx] = { ...products[idx], ...newProduct };
                    alert("✅ Cập nhật thành công!");
                }
            } else {
                // INSERT
                products.push(newProduct);
                alert("✅ Thêm mới thành công!");
            }

            // Sync DB
            db.products = products;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            
            closeModal();
            handleSearch(); // Refresh list
        }

        /* =========================================
           4. DELETE LOGIC
        ========================================= */
        function deleteProduct(id) {
            const p = products.find(x => x.id === id);
            
            // Giả lập logic: Các sản phẩm có ID bắt đầu bằng SP00... là dữ liệu mẫu, coi như đã có giao dịch
            // Các sản phẩm mới tạo có ID dạng SP + timestamp
            const hasHistory = id.startsWith('SP00'); 

            if (hasHistory) {
                // Kịch bản: Không cho xóa, gợi ý Ngưng kinh doanh
                if(confirm(`⚠️ Không thể xóa sản phẩm "${p.name}" do đã phát sinh giao dịch lịch sử!\n\nBạn có muốn chuyển sang trạng thái "NGƯNG KINH DOANH" không?`)) {
                    p.status = false; // Set inactive
                    db.products = products;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
                    handleSearch();
                }
            } else {
                // Sản phẩm mới chưa có giao dịch -> Cho phép xóa thật
                if(confirm(`Bạn có chắc chắn muốn XÓA VĨNH VIỄN sản phẩm "${p.name}"?`)) {
                    products = products.filter(x => x.id !== id);
                    db.products = products;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
                    handleSearch();
                }
            }
        }

    </script>
</body>
</html>